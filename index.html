<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VW FTF Master Dashboard v4</title>
    <style>
        :root {
            --bg: #121212;
            --panel: #1e1e1e;
            --border: #333;
            --text: #e0e0e0;
            --accent: #4ec9b0;
            --idle: #2196f3;
            --active: #4caf50;
            --warn: #ff9800;
        }
        body { font-family: 'Segoe UI', 'Roboto', monospace; background: var(--bg); color: var(--text); margin: 0; padding: 20px; font-size: 14px; }
        
        /* Layout */
        .container { max-width: 98%; margin: 0 auto; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border); }
        h1 { margin: 0; font-weight: 300; letter-spacing: 2px; color: var(--accent); }
        
        /* Buttons */
        .btn { background: #2d2d2d; border: 1px solid #444; color: #ccc; padding: 8px 16px; border-radius: 4px; cursor: pointer; transition: 0.2s; font-weight: 600; }
        .btn:hover { border-color: var(--accent); color: var(--accent); background: #333; }
        .btn-primary { background: #005f50; border-color: #005f50; color: white; }
        .btn-primary:hover { background: #00796b; }

        /* Upload Area */
        .grid-upload { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .drop-zone { 
            background: var(--panel); border: 2px dashed var(--border); border-radius: 8px; padding: 20px; 
            text-align: center; transition: 0.2s; cursor: pointer; position: relative;
        }
        .drop-zone:hover { border-color: var(--accent); background: #252526; }
        .drop-zone.has-file { border-color: var(--active); background: #1b261b; }
        .drop-zone h3 { margin: 0 0 5px 0; font-size: 1.1em; color: #fff; }
        .file-meta { font-size: 0.85em; color: #888; font-family: monospace; }

        /* Main Table */
        table { width: 100%; border-collapse: separate; border-spacing: 0; background: var(--panel); border-radius: 8px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.4); }
        th { background: #252526; text-align: left; padding: 12px 15px; text-transform: uppercase; font-size: 0.75em; letter-spacing: 1px; color: #888; border-bottom: 1px solid var(--border); }
        td { padding: 10px 15px; border-bottom: 1px solid var(--border); vertical-align: middle; }
        tr:last-child td { border-bottom: none; }
        tr:hover td { background: #2a2a2b; }

        /* ID & Cluster Styling */
        .cluster-badge { 
            display: inline-block; width: 30px; height: 30px; line-height: 30px; text-align: center; 
            border-radius: 50%; font-weight: bold; font-size: 12px; color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.5);
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .id-text { font-family: 'Consolas', monospace; font-size: 1.2em; font-weight: 700; letter-spacing: 1px; color: #fff; }
        
        /* Status Flags */
        .status-pill { 
            display: inline-flex; align-items: center; padding: 4px 10px; border-radius: 12px; 
            font-size: 0.85em; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;
            border: 1px solid transparent;
        }
        .st-active { background: rgba(76, 175, 80, 0.15); color: #66bb6a; border-color: rgba(76, 175, 80, 0.3); }
        .st-idle { background: rgba(33, 150, 243, 0.15); color: #64b5f6; border-color: rgba(33, 150, 243, 0.3); }
        .st-warn { background: rgba(255, 152, 0, 0.15); color: #ffb74d; border-color: rgba(255, 152, 0, 0.3); }
        .st-unk { background: #333; color: #aaa; border-color: #444; }
        .st-dot { width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; background: currentColor; box-shadow: 0 0 6px currentColor; }

        /* Type Badges */
        .type-tag { font-size: 0.7em; padding: 2px 5px; border-radius: 3px; text-transform: uppercase; border: 1px solid #444; color: #888; margin-left: 5px; }
        .type-mob { border-color: #004d40; color: #80cbc4; background: #00251e; }
        .type-stat { border-color: #3e2723; color: #d7ccc8; background: #1b0000; }

        /* Payload Hex View */
        .hex-row { font-family: 'Consolas', monospace; font-size: 0.9em; color: #666; margin-top: 4px; display: flex; align-items: center; }
        .h-def { color: #569cd6; }
        .h-val { color: #ce9178; }
        .h-sep { color: #c586c0; font-weight: bold; }
        .h-id { color: var(--accent); text-decoration: underline; text-decoration-style: dotted; }

        /* Sparkline */
        .spark-wrap { width: 140px; height: 40px; position: relative; }
        .spark-svg { width: 100%; height: 100%; }
        .spark-line { fill: none; stroke: var(--accent); stroke-width: 2; stroke-linecap: round; vector-effect: non-scaling-stroke; }
        .spark-rssi { position: absolute; bottom: 2px; right: 2px; font-size: 9px; color: #aaa; background: rgba(0,0,0,0.6); padding: 1px 3px; border-radius: 3px; }

        /* Diff Rows */
        .row-new td { background: rgba(76, 175, 80, 0.08); border-top: 1px solid rgba(76, 175, 80, 0.3); }
        .row-gone td { background: rgba(244, 67, 54, 0.08); opacity: 0.6; }
        .badge-diff { font-size: 0.7em; padding: 2px 6px; border-radius: 4px; margin-left: 8px; font-weight: bold; }
        .bd-new { background: #2e7d32; color: white; }
        .bd-gone { background: #c62828; color: white; }

        /* Modal (Bit Flipper) */
        #bitModal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.85); z-index: 100; backdrop-filter: blur(4px); }
        .modal-box { background: #1e1e1e; width: 80%; max-width: 900px; margin: 50px auto; border-radius: 8px; border: 1px solid #444; box-shadow: 0 20px 60px rgba(0,0,0,0.5); }
        .modal-head { padding: 15px 20px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 20px; overflow-y: auto; max-height: 80vh; display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; }
        .bit-block { background: #252526; padding: 10px; border-radius: 4px; border: 1px solid #333; text-align: center; }
        .bit-hex { font-size: 1.4em; font-weight: bold; color: var(--accent); font-family: 'Consolas', monospace; }
        .bit-bin { font-family: 'Consolas', monospace; font-size: 0.85em; color: #666; letter-spacing: 1px; margin-top: 5px; }
        .bit-idx { font-size: 0.7em; color: #444; text-transform: uppercase; margin-top: 5px; }
        
        /* Color generator for clusters */
        .c-0 { background: #E91E63; } .c-1 { background: #9C27B0; } .c-2 { background: #673AB7; }
        .c-3 { background: #3F51B5; } .c-4 { background: #2196F3; } .c-5 { background: #00BCD4; }
        .c-6 { background: #009688; } .c-7 { background: #4CAF50; } .c-8 { background: #8BC34A; }
        .c-9 { background: #CDDC39; } .c-A { background: #FFC107; } .c-B { background: #FF9800; }
        .c-C { background: #FF5722; } .c-D { background: #795548; } .c-E { background: #607D8B; } .c-F { background: #9E9E9E; }
    </style>
</head>
<body>

<div class="container">
    <div class="top-bar">
        <h1>VW FTF Intelligence <span style="font-size:0.5em; color:#666; vertical-align:middle;">v4.0</span></h1>
        <div>
            <button class="btn" onclick="exportCSV()">ðŸ“¥ CSV Export</button>
        </div>
    </div>

    <div class="grid-upload">
        <div class="drop-zone" id="dropA" onclick="document.getElementById('fileA').click()">
            <input type="file" id="fileA" hidden accept=".json" onchange="loadFile(this, 'A')">
            <h3>REFERENZ SCAN (A)</h3>
            <div class="file-meta" id="metaA">Keine Datei</div>
        </div>
        <div class="drop-zone" id="dropB" onclick="document.getElementById('fileB').click()">
            <input type="file" id="fileB" hidden accept=".json" onchange="loadFile(this, 'B')">
            <h3>VERGLEICHS SCAN (B)</h3>
            <div class="file-meta" id="metaB">Keine Datei</div>
        </div>
    </div>

    <table id="fleetTable">
        <thead>
            <tr>
                <th width="5%">Cluster</th>
                <th width="10%">ID (TID)</th>
                <th width="35%">Scan A (Status & Signal)</th>
                <th width="5%"></th>
                <th width="35%">Scan B (Status & Signal)</th>
                <th width="10%">Tools</th>
            </tr>
        </thead>
        <tbody id="tableBody">
            <tr><td colspan="6" style="text-align:center; padding:60px; color:#444; font-style:italic;">Lade .json Dateien hoch, um die Flotte zu analysieren.</td></tr>
        </tbody>
    </table>
</div>

<div id="bitModal">
    <div class="modal-box">
        <div class="modal-head">
            <h3 style="margin:0; color:#fff">Payload Inspector</h3>
            <span style="cursor:pointer; font-size:24px;" onclick="document.getElementById('bitModal').style.display='none'">&times;</span>
        </div>
        <div class="modal-body" id="bitContent"></div>
    </div>
</div>

<script>
    let fleetA = {}, fleetB = {};

    function loadFile(input, slot) {
        const file = input.files[0];
        if (!file) return;
        
        document.getElementById('meta' + slot).innerText = `${file.name} (${(file.size/1024).toFixed(1)} KB)`;
        document.getElementById('drop' + slot).classList.add('has-file');

        const reader = new FileReader();
        reader.onload = e => {
            try {
                const json = JSON.parse(e.target.result);
                const devices = analyzeLog(json);
                if (slot === 'A') fleetA = devices;
                if (slot === 'B') fleetB = devices;
                render();
            } catch (err) { alert("JSON Error: " + err); }
        };
        reader.readAsText(file);
    }

    // --- THE BRAIN: Parsing & Logic ---
    function analyzeLog(json) {
        let map = {};
        
        const add = (p, rssi, t) => {
            if (!p || p.length < 16) return;
            
            let id, type, statusHex, isCrypto = false;

            // Rule 1: Standard (1006...)
            if (p.startsWith('1006')) {
                const sep = p.substring(6, 8);
                statusHex = p.substring(4, 6);
                id = p.substring(8, 14);
                
                if (sep === '1E' || sep === '1D') type = 'MOBIL';
                else if (sep === '1A') type = 'STATION';
                else return; // Ignore non-FTF
            }
            // Rule 2: Crypto (0C0E...)
            else if (p.startsWith('0C0E')) {
                // Find footer "1005"
                const fIdx = p.indexOf('1005');
                if (fIdx === -1) return;
                
                statusHex = p.substring(fIdx + 4, fIdx + 6);
                id = p.substring(fIdx + 8, fIdx + 14);
                type = 'MOBIL';
                isCrypto = true;
            }
            // Rule 3: Special Infra (2DC1...)
            else if (p.startsWith('2DC1')) {
                id = p.substring(2, 8);
                type = 'BAU';
                statusHex = 'FF';
            }
            else return;

            if (!map[id]) map[id] = { id, type, history: [], lastPayload: p, lastStatus: statusHex, maxRssi: -100, isCrypto };
            
            // Prioritize crypto payloads for display
            if (isCrypto) { map[id].isCrypto = true; map[id].lastPayload = p; }
            
            // Update latest status if not crypto
            if (!map[id].isCrypto) {
                map[id].lastPayload = p;
                map[id].lastStatus = statusHex;
            }

            map[id].history.push({t, r: rssi});
            if (rssi > map[id].maxRssi && rssi < 0) map[id].maxRssi = rssi;
        };

        json.devices.forEach(d => {
            if (d.rawDataPayload) add(d.rawDataPayload, d.rssi || -99, 0);
            if (d.history) d.history.forEach(h => add(h.p, h.r, h.t));
        });
        return map;
    }

    // --- RENDERING ---
    function render() {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        
        const allIds = new Set([...Object.keys(fleetA), ...Object.keys(fleetB)]);
        const sorted = Array.from(allIds).sort();

        if (sorted.length === 0) { tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:40px">Keine FTFs gefunden.</td></tr>'; return; }

        sorted.forEach(id => {
            const a = fleetA[id];
            const b = fleetB[id];
            const item = a || b;
            
            // Cluster Logic (First Char of ID)
            const clusterChar = id.charAt(0).toUpperCase();
            const clusterClass = 'c-' + (/[0-9A-F]/.test(clusterChar) ? clusterChar : 'F');

            let rowClass = '';
            let badgeHtml = '';
            if (b && !a) { rowClass = 'row-new'; badgeHtml = '<span class="badge-diff bd-new">NEU</span>'; }
            if (a && !b) { rowClass = 'row-gone'; badgeHtml = '<span class="badge-diff bd-gone">WEG</span>'; }

            // Type Label
            let typeLabel = item.type === 'MOBIL' ? '<span class="type-tag type-mob">ðŸšœ FTF</span>' : '<span class="type-tag type-stat">âš“ STATION</span>';

            const tr = document.createElement('tr');
            tr.className = rowClass;
            tr.innerHTML = `
                <td style="text-align:center"><div class="cluster-badge ${clusterClass}">${clusterChar}</div></td>
                <td>
                    <div class="id-text">${id}</div>
                    ${typeLabel} ${badgeHtml}
                </td>
                <td>${renderCell(a)}</td>
                <td style="text-align:center; color:#444">${(a&&b) ? 'âžœ' : ''}</td>
                <td>${renderCell(b)}</td>
                <td><button class="btn" onclick="showBits('${item.lastPayload}')" style="padding:4px 10px; font-size:12px">ðŸ”¬</button></td>
            `;
            tbody.appendChild(tr);
        });
    }

    function renderCell(obj) {
        if (!obj) return '<span style="color:#444; font-style:italic">-</span>';
        
        // Status Decoder
        const s = obj.lastStatus;
        let sLabel = 'UNK';
        let sClass = 'st-unk';
        const sByte = parseInt(s, 16);

        if ((sByte >= 0x70 && sByte <= 0x7F)) { sLabel = 'AKTIV'; sClass = 'st-active'; } // 7x
        else if ((sByte >= 0x30 && sByte <= 0x3F)) { sLabel = 'IDLE'; sClass = 'st-idle'; } // 3x
        else if ((sByte >= 0x20 && sByte <= 0x2F)) { sLabel = 'SONDER'; sClass = 'st-warn'; } // 2x
        
        // Payload Formatting
        let pHtml = obj.lastPayload;
        if (pHtml.startsWith('1006')) {
            pHtml = `<span class="h-def">1006</span><span class="h-val">${s}</span><span class="h-sep">${pHtml.substr(6,2)}</span><span class="h-id">${obj.id}</span>...`;
        } else if (pHtml.startsWith('0C0E')) {
            pHtml = `<span class="h-def">0C0E</span> <span class="h-val" style="color:#ff9800">AES</span> ... <span class="h-id">${obj.id}</span>`;
        }

        return `
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <div class="status-pill ${sClass}"><div class="st-dot"></div>${sLabel} <span style="opacity:0.7; font-size:0.9em; margin-left:5px">(${s})</span></div>
                    <div class="hex-row">${pHtml}</div>
                </div>
                ${renderSpark(obj.history)}
            </div>
        `;
    }

    function renderSpark(hist) {
        if (!hist || hist.length < 2) return '';
        hist.sort((a,b) => a.t - b.t);
        
        const w=100, h=30;
        const minT = hist[0].t, dur = hist[hist.length-1].t - minT || 1;
        
        let d = "";
        hist.forEach((pt, i) => {
            const x = ((pt.t - minT) / dur) * w;
            // RSSI -100 to -40
            let y = h - ((pt.r + 100) / 60) * h;
            y = Math.max(0, Math.min(h, y));
            d += `${i===0?'M':'L'} ${x} ${y} `;
        });

        return `
            <div class="spark-wrap">
                <svg class="spark-svg" viewBox="0 0 ${w} ${h}" preserveAspectRatio="none">
                    <path class="spark-line" d="${d}"/>
                </svg>
                <div class="spark-rssi">${hist[hist.length-1].r}dBm</div>
            </div>
        `;
    }

    // --- BIT FLIPPER ---
    function showBits(hex) {
        const el = document.getElementById('bitContent');
        el.innerHTML = '';
        
        for (let i=0; i<hex.length; i+=2) {
            const byteVal = parseInt(hex.substr(i,2), 16);
            const bin = byteVal.toString(2).padStart(8,'0');
            
            // Determine label based on index
            let label = `Byte ${i/2}`;
            if (i===0) label = "HEAD";
            if (i===4) label = "STAT";
            if (i===6) label = "SEP";
            
            // Colorize bits
            let binHtml = '';
            for (let b of bin) binHtml += `<span style="color:${b==='1'?'#4ec9b0':'#444'}; font-weight:${b==='1'?'bold':'normal'}">${b}</span>`;

            el.innerHTML += `
                <div class="bit-block" style="border-color:${(i/2 < 2)?'#569cd6':'#333'}">
                    <div class="bit-hex">${hex.substr(i,2)}</div>
                    <div class="bit-bin">${binHtml}</div>
                    <div class="bit-idx">${label}</div>
                </div>
            `;
        }
        document.getElementById('bitModal').style.display = 'block';
    }

    function exportCSV() {
        if (!fleetA && !fleetB) return alert("Nichts zu exportieren.");
        let csv = "Cluster;ID;Typ;Status_A;RSSI_A;Status_B;RSSI_B\n";
        const ids = new Set([...Object.keys(fleetA), ...Object.keys(fleetB)]);
        
        ids.forEach(id => {
            const a = fleetA[id], b = fleetB[id];
            const item = a || b;
            csv += `${id[0]};${id};${item.type};${a?a.lastStatus:''};${a?a.maxRssi:''};${b?b.lastStatus:''};${b?b.maxRssi:''}\n`;
        });
        
        const blob = new Blob([csv], {type: 'text/csv'});
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'vw_ftf_flotte.csv'; a.click();
    }
</script>

</body>
</html>
